networks:
    # rete per la comunicazione interna dei containers
    auth-net:
        name: auth-net

    # rete di default per la comunicazione con il proxy,
    # da instanziare solo sui containers che si espongono
    default:
        name: traefik_net
        external: true

##########################################
secrets:
    MONGO_ROOT_PW:
        file: lib/secrets/MONGO_ROOT_PW
    MONGO_USER_PW:
        file: lib/secrets/MONGO_USER_PW
    MAIL_CONFIG:
        file: lib/secrets/MAIL_CONFIG

##########################################
volumes:
    auth-vol:
        name: auth-vol

##########################################
services:
    backend:
        build:
            context: ./
            dockerfile: Dockerfile.dev.api
        restart: unless-stopped
        container_name: backend
        environment:
            MODE: PRODUCTION
            TZ: Europe/Rome
            MONGO_USER: auth_user
            MONGO_DB: auth
            MONGO_HOST: mongo1.dag.lan:27017,mongo2.dag.lan:27017,mongo3.dag.lan:27017
        networks:
            - auth-net
            - default
        # ports:
        #     - 8000:8000
        volumes:
            - ./backend:/app
            - ./lib/assets:/app/assets
            # - /etc/timezone:/etc/timezone:ro
            # - /etc/localtime:/etc/localtime:ro
        secrets:
            - MAIL_CONFIG
            - MONGO_USER_PW

        # network_mode: "bridge"

        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.certauthapi.rule=Host(`ca.dag.lan`) && PathPrefix(`/api`) "
            - "traefik.http.routers.certauthapi.entrypoints=websecure"
            - "traefik.http.routers.certauthapi.tls=true"
            # - "traefik.http.routers.certauthapi.tls.certresolver=le"
            - "traefik.http.routers.certauthapi.middlewares=api_stripprefix@docker"
            - "traefik.http.middlewares.api_stripprefix.stripprefix.prefixes=/api"
